<project name="JSCover" basedir="." default="pre-commit">

	<property environment="env" />

	<property file="build.properties" />
	<property file="src/main/resources/jscover/server/configuration.properties" />

	<path id="classpath-main">
		<pathelement path="${classes.main.dir}" />
		<pathelement path="${classes.test-unit.dir}" />
		<pathelement path="${classes.test-integration.dir}" />
		<fileset dir="${lib.build.dir}" includes="**/*.jar" />
		<fileset dir="${lib.run.dir}" includes="*.jar" />
	</path>

	<path id="classpath-cobertura">
		<pathelement path="${classes.instrumented.dir}" />
		<pathelement path="${classes.main.dir}" />
		<pathelement path="${classes.test-unit.dir}" />
		<pathelement path="${classes.test-integration.dir}" />
		<fileset dir="${lib.build.dir}" includes="**/*.jar" />
		<fileset dir="${lib.run.dir}" includes="*.jar" />
	</path>

	<target name="clean">
		<delete dir="target" />
		<delete file="cobertura.ser" />
	</target>

	<target name="dirsetup">
		<mkdir dir="${build.dir}" />
		<mkdir dir="${build.dir}/reports" />
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${report.test.dir}" />
		<mkdir dir="${report.spec.dir}" />
		<mkdir dir="${report.checkstyle.dir}" />
		<mkdir dir="${classes.main.dir}" />
		<mkdir dir="${classes.instrumented.dir}" />
		<mkdir dir="${classes.test-unit.dir}" />
		<mkdir dir="${classes.test-integration.dir}" />
	</target>

	<target name="compile" depends="dirsetup">
		<javac includeantruntime="false" debug="true" srcdir="${src.main.dir}" destdir="${classes.main.dir}" classpathref="classpath-main" />
		<copy todir="${classes.main.dir}" includeemptydirs="no">
			<fileset dir="${src.resources.dir}" />
		</copy>
	</target>

    <target name="stop-server">
        <get src="http://localhost:8080/stop" dest="${build.dir}/stop.txt" verbose="true"/>
	</target>

    <target name="jar" depends="compile">
        <!--
        TODO copy all run-time using filter *.jar and use ant-contrib to
        dynamically create the 'Class-Path' manifest entry
        -->
        <copy file="lib/runtime/commons-io-1.4.jar" todir="${dist.dir}"/>
        <copy file="lib/runtime/commons-lang-2.4.jar" todir="${dist.dir}"/>
        <copy file="lib/runtime/js.jar" tofile="${dist.dir}/js-1.7R4.jar"/>
        <jar jarfile="${dist.dir}/${ant.project.name}.jar"
             basedir="${classes.main.dir}"
             compress="true">
            <manifest>
                <attribute name="Implementation-Title" value="${ant.project.name}"/>
                <attribute name="Implementation-Version" value="${version}"/>
                <attribute name="Main-Class" value="jscover.server.WebServer"/>
                <attribute name="Class-Path" value="commons-io-1.4.jar commons-lang-2.4.jar js-1.7R4.jar"/>
            </manifest>
        </jar>
    </target>

    <target name="jar-all" depends="compile">
        <property name="tmpDir" value="${build.dir}/tmp"/>
        <mkdir dir="${tmpDir}"/>
        <unzip src="lib/runtime/commons-io-1.4.jar" dest="${tmpDir}"/>
        <unzip src="lib/runtime/commons-lang-2.4.jar" dest="${tmpDir}"/>
        <move file="${tmpDir}/META-INF/LICENSE.txt" tofile="${tmpDir}/META-INF/LICENSE-apache.txt"/>
        <move file="${tmpDir}/META-INF/NOTICE.txt" tofile="${tmpDir}/META-INF/NOTICE-apache.txt"/>
        <unzip src="lib/runtime/js.jar" dest="${tmpDir}"/>
        <move file="${tmpDir}/LICENSE.txt" tofile="${tmpDir}/META-INF/LICENSE-mozilla.txt"/>
        <copy todir="${tmpDir}" includeemptydirs="no">
            <fileset dir="${classes.main.dir}" />
        </copy>
        <jar jarfile="${dist.dir}/${ant.project.name}-all.jar"
             basedir="${tmpDir}"
             compress="true">
            <manifest>
                <attribute name="Implementation-Title" value="JSCover"/>
                <attribute name="Implementation-Version" value="${version}"/>
                <attribute name="Main-Class" value="jscover.server.WebServer"/>
            </manifest>
        </jar>
    </target>

    <target name="zip" depends="pre-commit, jar">
        <zip destfile="${dist.dir}/${ant.project.name}-${version}.zip">
            <fileset dir="${basedir}">
                <include name="**/*"/>
                <exclude name=".*/**"/>
                <exclude name="bin/**"/>
                <exclude name="${build.dir}/**"/>
            </fileset>
            <fileset dir="${basedir}">
                <include name="${dist.dir}/*.jar"/>
            </fileset>
        </zip>
    </target>

    <taskdef classpathref="classpath-cobertura" resource="tasks.properties" />
	<target name="cobertura-setup" depends="compile">
		<delete file="cobertura.ser" failonerror="false" />
		<cobertura-instrument todir="${classes.instrumented.dir}">
			<ignore regex="org.apache.log4j.*" />
			<fileset dir="${classes.main.dir}">
				<include name="**/*.class" />
				<exclude name="**/WebServer.class" />
				<exclude name="**/NanoHTTPD*.class" />
			</fileset>
			<classpath>
				<path refid="classpath-cobertura" />
			</classpath>
		</cobertura-instrument>
		<copy todir="${classes.instrumented.dir}" includeemptydirs="no">
			<fileset dir="${src.resources.dir}" />
			<fileset dir="${src.test-integration.resources.dir}" />
		</copy>
	</target>

	<target name="cobertura-report">
		<cobertura-report format="html" destdir="${report.coverage.dir}" srcdir="${src.main.dir}" />
	</target>

	<target name="coverage-check">
		<cobertura-check totallinerate="87" totalbranchrate="89"/>
	</target>

	<target name="compile-tests" depends="compile">
		<javac includeantruntime="false" debug="true" srcdir="${src.test-unit.dir}"
			destdir="${classes.test-unit.dir}" classpathref="classpath-main" />
		<copy todir="${classes.test-unit.dir}" includeemptydirs="no">
			<fileset dir="${src.test-resources.dir}" />
		</copy>
	</target>

	<target name="compile-integration-tests" depends="compile-tests">
		<javac includeantruntime="false" debug="true" srcdir="${src.test-integration.dir}"
			destdir="${classes.test-integration.dir}" classpathref="classpath-main" />
		<copy todir="${classes.test-integration.dir}" includeemptydirs="no">
			<fileset dir="${src.test-integration.resources.dir}" />
		</copy>
	</target>

	<target name="run-tests" depends="compile-integration-tests, cobertura-setup">
		<property name="tests" value="*Test" />
		<delete dir="${report.test.dir}" />
		<mkdir dir="${report.test.dir}" />
		<junit forkmode="perBatch" haltonfailure="no" haltonerror="no" failureProperty="test.failure">
			<classpath>
				<path refid="classpath-cobertura" />
			</classpath>
			<formatter type="xml" />
			<formatter type="brief" usefile="no" />
			<batchtest fork="yes" todir="${report.test.dir}">
				<fileset dir="${classes.test-unit.dir}">
					<include name="**/${tests}.class" />
				</fileset>
				<fileset dir="${classes.test-integration.dir}">
					<include name="**/${tests}.class" />
				</fileset>
			</batchtest>
		</junit>
		<antcall target="junitreport" />
		<fail if="test.failure"/>
	</target>

	<target name="junitreport" unless="continuous.integration">
		<junitreport todir="${report.test.dir}">
			<fileset dir="${report.test.dir}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="frames" todir="${report.test.dir}" />
		</junitreport>
	</target>

	<target name="junit" depends="run-tests, junitreport, cobertura-report, coverage-check"/>

	<target name="pre-commit" depends="clean, junit"/>
</project>
